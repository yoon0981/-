<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>키워드 검색</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#111111" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial; margin:0; background:#0b0c10; color:#f5f5f5;}
    .wrap{max-width:820px; margin:0 auto; padding:18px;}
    h1{font-size:20px; margin:4px 0 14px;}
    input{width:100%; padding:14px 12px; border-radius:12px; border:1px solid #2a2c33; background:#12131a; color:#fff; font-size:16px; outline:none;}
    .hint{color:#a9acb6; font-size:13px; margin:10px 2px 14px;}
    .section{margin-top:18px;}
    .section h2{font-size:14px; color:#c9cad1; margin:18px 2px 8px;}
    .card{border:1px solid #2a2c33; background:#12131a; border-radius:14px; padding:12px; margin:10px 0;}
    .name{font-size:16px; font-weight:700; margin-bottom:6px;}
    .addr{font-size:13px; color:#b7bac5; margin-bottom:6px;}
    .note{font-size:13px; color:#cfd2dc; line-height:1.45; white-space:pre-wrap;}
    .empty{color:#a9acb6; margin-top:16px;}
    .footer{margin:18px 0 6px; color:#808392; font-size:12px;}
    .btnRow{display:flex; gap:10px; margin-top:10px;}
    button{padding:10px 12px; border-radius:12px; border:1px solid #2a2c33; background:#191b24; color:#fff; font-size:14px;}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>키워드 검색</h1>
    <input id="q" placeholder="이름 / 주소 / 메모 키워드" autocomplete="off" />
    <div class="hint">예: "좋은하루", "게이트", "다산", "주차"</div>
    <div id="out"></div>
    <div class="footer">홈 화면에 추가하면 앱처럼 사용할 수 있어요.</div>
  </div>

<script>
let data = [];
const out = document.getElementById('out');
const q = document.getElementById('q');

function norm(s){
  return (s||"").toLowerCase().replace(/\s+/g,'');
}

function render(){
  const query = norm(q.value.trim());
  out.innerHTML = "";
  if(!data.length){ out.innerHTML = '<div class="empty">데이터를 불러오는 중…</div>'; return; }

  let groups = data;
  if(query){
    groups = data.map(g => ({
      group: g.group,
      items: g.items.filter(it => norm(it.name + it.note + it.address).includes(query))
    })).filter(g => g.items.length);
  }

  if(!groups.length){
    out.innerHTML = '<div class="empty">검색 결과가 없어요.</div>';
    return;
  }

  for(const g of groups){
    const sec = document.createElement('div');
    sec.className = 'section';
    sec.innerHTML = `<h2>${g.group}</h2>`;
    for(const it of g.items){
      const card = document.createElement('div');
      card.className = 'card';
      const addr = it.address ? `<div class="addr">${it.address}</div>` : '';
      const note = it.note ? `<div class="note">${it.note}</div>` : '';
      card.innerHTML = `<div class="name">${it.name}</div>${addr}${note}`;
      const btnRow = document.createElement('div');
      btnRow.className='btnRow';
      const copyBtn = document.createElement('button');
      copyBtn.textContent='복사';
      copyBtn.onclick=async()=>{
        const text=[it.name,it.address,it.note].filter(Boolean).join('\n');
        try{ await navigator.clipboard.writeText(text); copyBtn.textContent='복사됨'; setTimeout(()=>copyBtn.textContent='복사',900); }catch(e){}
      };
      const mapBtn = document.createElement('button');
      mapBtn.textContent='T맵';
      mapBtn.onclick=async ()=>{
        const keyword = (it.address||it.name||'').trim();
        if(!keyword){
          alert('주소/이름이 비어있어요.');
          return;
        }

        // 좌표변환 없이 T맵 검색 우선 방식 (iPhone/PWA에서 더 안정적)
        try{ await navigator.clipboard.writeText(keyword); }catch(e){}

        const encoded = encodeURIComponent(keyword);
        // 기기/버전마다 파라미터명이 다를 수 있어 순차 시도
        const candidates = [
          `tmap://search?name=${encoded}`,
          `tmap://search?query=${encoded}`,
          `tmap://search?searchWord=${encoded}`,
          'tmap://'
        ];
        const storeUrl = 'https://apps.apple.com/kr/app/id431589174';

        let step = 0;
        const launches = [];
        const tryNext = ()=>{
          if(step >= candidates.length) return;
          window.location.href = candidates[step++];
          if(step < candidates.length){
            launches.push(setTimeout(tryNext, 700));
          }
        };

        const storeTimer = setTimeout(()=>{
          // 앱 미설치/스킴 실패 시 안내 (검색어는 이미 복사됨)
          alert('티맵 검색어를 복사해뒀어요. 티맵이 열리면 붙여넣어 검색하면 돼요.\n\n복사된 검색어:\n' + keyword);
          window.location.href = storeUrl;
        }, 2600);

        const onVis = ()=>{
          if(document.hidden){
            clearTimeout(storeTimer);
            launches.forEach(clearTimeout);
          }
        };
        document.addEventListener('visibilitychange', onVis, {once:true});

        tryNext();
      };
      btnRow.appendChild(copyBtn);
      btnRow.appendChild(mapBtn);
      card.appendChild(btnRow);
      sec.appendChild(card);
    }
    out.appendChild(sec);
  }
}

q.addEventListener('input', render);

async function init(){
  try{
    const res = await fetch('places.json', {cache:'no-store'});
    data = await res.json();
  }catch(e){
    out.innerHTML = '<div class="empty">places.json을 불러오지 못했어요.</div>';
  }
  render();
  if('serviceWorker' in navigator){
    try{ await navigator.serviceWorker.register('service-worker.js'); }catch(e){}
  }
}
init();
</script>
</body>
</html>
